<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لوحة تحكم الأدمن - نشر منتج</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; direction: rtl; }
    input, button, select { display: block; margin: 10px 0; width: 100%; padding: 8px; font-size: 1rem; }
    #publishSection { display: none; }
    #status { margin-top: 15px; }
  </style>
</head>
<body>

  <h2 id="pageTitle">تسجيل دخول الأدمن</h2>

  <div id="loginSection">
    <input type="email" id="emailInput" placeholder="البريد الإلكتروني" />
    <input type="password" id="passwordInput" placeholder="كلمة المرور" />
    <button id="loginBtn">تسجيل الدخول</button>
  </div>

  <div id="publishSection">
    <button id="logoutBtn" style="float:left; margin-bottom: 20px;">تسجيل خروج</button>
    <h2>نشر منتج جديد</h2>

    <input type="file" id="imageInput" accept="image/*" />
    <input type="text" id="productTitle" placeholder="عنوان المنتج" />
    <input type="number" id="productPrice" placeholder="سعر المنتج (بالدينار العراقي)" min="0" step="0.01" />
    
    <select id="sectionFile">
      <option value="">اختر القسم</option>
      <option value="devices.html">الأجهزة</option>
      <option value="tools.html">عدد يدوية</option>
      <option value="appliances.html">أجهزة منزلية</option>
      <option value="electronics.html">إلكترونيات</option>
    </select>

    <button id="publishBtn">نشر المنتج</button>

    <div id="status"></div>
  </div>

<script>
  // بيانات الأدمن مشفرة بـ Base64
  const ADMIN_EMAIL = atob('YWxpaGFpZGVybmV0LmFoQGdtYWlsLmNvbQ=='); // alihaidernet.ah@gmail.com
  const ADMIN_PASSWORD = atob('NTU2NjMyMTU1NTYzMjE='); // 55663215566321

  const CLIENT_ID = '46aa6ce80146b0e';
  const GITHUB_TOKEN = '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';
  const OWNER = 'mouswie';
  const REPO = 'rukn_albay';
  const BRANCH = 'main';

  const loginSection = document.getElementById('loginSection');
  const publishSection = document.getElementById('publishSection');
  const pageTitle = document.getElementById('pageTitle');
  const statusDiv = document.getElementById('status');

  function showStatus(msg, isError = false) {
    statusDiv.textContent = msg;
    statusDiv.style.color = isError ? 'red' : 'green';
  }

  function checkLogin() {
    const saved = localStorage.getItem('admin_logged_in');
    if (saved === 'true') {
      loginSection.style.display = 'none';
      publishSection.style.display = 'block';
      pageTitle.textContent = 'لوحة تحكم الأدمن - نشر منتج';
      showStatus('');
    } else {
      loginSection.style.display = 'block';
      publishSection.style.display = 'none';
      pageTitle.textContent = 'تسجيل دخول الأدمن';
      showStatus('');
    }
  }

  document.getElementById('loginBtn').onclick = () => {
    const email = document.getElementById('emailInput').value.trim();
    const pass = document.getElementById('passwordInput').value;

    if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){
      localStorage.setItem('admin_logged_in', 'true');
      checkLogin();
    } else {
      showStatus('خطأ: البريد الإلكتروني أو كلمة المرور غير صحيحة', true);
    }
  };

  document.getElementById('logoutBtn').onclick = () => {
    localStorage.removeItem('admin_logged_in');
    checkLogin();
    showStatus('تم تسجيل الخروج');
  };

  checkLogin();

  async function uploadImageToImgur(imageFile) {
    const formData = new FormData();
    formData.append('image', imageFile);

    const response = await fetch('https://api.imgur.com/3/image', {
      method: 'POST',
      headers: {
        Authorization: 'Client-ID ' + CLIENT_ID
      },
      body: formData
    });

    const data = await response.json();
    if (data.success) {
      return data.data.link;
    } else {
      throw new Error('فشل رفع الصورة: ' + data.data.error);
    }
  }

  async function getFileContent(path) {
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/products/${path}?ref=${BRANCH}`;
    const response = await fetch(url, {
      headers: { Authorization: `token ${GITHUB_TOKEN}` }
    });
    if (!response.ok) throw new Error('فشل جلب الملف من GitHub');
    return await response.json();
  }

  async function updateFileContent(path, newContent, sha, message) {
    const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/products/${path}`;
    const body = {
      message: message,
      content: btoa(unescape(encodeURIComponent(newContent))),
      sha: sha,
      branch: BRANCH
    };
    const response = await fetch(url, {
      method: 'PUT',
      headers: {
        Authorization: `token ${GITHUB_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error('فشل تحديث الملف في GitHub: ' + (errorData.message || response.statusText));
    }
    return await response.json();
  }

  async function addProductToSection(sectionFileName, productHtml) {
    showStatus('جاري جلب ملف القسم...');
    const fileData = await getFileContent(sectionFileName);
    const decodedContent = decodeURIComponent(escape(atob(fileData.content)));
    const newContent = productHtml + '\n' + decodedContent;
    showStatus('جاري تحديث الملف في GitHub...');
    await updateFileContent(sectionFileName, newContent, fileData.sha, 'نشر منتج جديد');
    showStatus('تم نشر المنتج بنجاح!');
  }

  document.getElementById('publishBtn').onclick = async () => {
    const title = document.getElementById('productTitle').value.trim();
    const price = document.getElementById('productPrice').value.trim();
    const section = document.getElementById('sectionFile').value;
    const imageFile = document.getElementById('imageInput').files[0];

    if (!title || !price || !section || !imageFile) {
      showStatus('يرجى تعبئة جميع الحقول واختيار صورة', true);
      return;
    }

    try {
      showStatus('جاري رفع الصورة...');
      const imageUrl = await uploadImageToImgur(imageFile);
      const productHTML = `
<div class="product-card">
  <img src="${imageUrl}" alt="${title}" />
  <h3>${title}</h3>
  <p><strong>${price} دينار</strong></p>
</div>`;

      await addProductToSection(section, productHTML);
    } catch (err) {
      showStatus(err.message, true);
    }
  };
</script>

</body>
</html>
